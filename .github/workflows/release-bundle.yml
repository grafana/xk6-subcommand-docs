name: Release Doc Bundle

on:
  repository_dispatch:
    types: [k6-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'k6 version (e.g., v1.5.x)'
        required: true

jobs:
  build-bundle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version-file: go.mod
      - name: Resolve version
        id: version
        run: |
          RAW="${{ github.event.client_payload.version || github.event.inputs.version }}"
          # Ensure v prefix
          RAW="${RAW#v}"
          RAW="v${RAW}"
          # Map to wildcard: v1.6.1 → v1.6.x
          WILDCARD=$(echo "$RAW" | sed 's/\.[0-9]*$/\.x/')
          echo "exact=$RAW" >> "$GITHUB_OUTPUT"
          echo "wildcard=$WILDCARD" >> "$GITHUB_OUTPUT"
          echo "Exact: $RAW → Wildcard: $WILDCARD"
      - name: Clone k6-docs
        run: git clone --depth 1 https://github.com/grafana/k6-docs.git /tmp/k6-docs
      - name: Prepare docs
        run: go run ./cmd/prepare --k6-version=${{ steps.version.outputs.exact }} --k6-docs-path=/tmp/k6-docs --output-dir=dist
      - name: Compress bundle
        run: |
          sudo apt-get update && sudo apt-get install -y zstd
          tar -cf - -C dist . | zstd --ultra -22 -o docs-${{ steps.version.outputs.wildcard }}.tar.zst
      - name: Publish release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: doc-bundles
          name: "Docs"
          make_latest: false
          files: docs-${{ steps.version.outputs.wildcard }}.tar.zst
          body: "This is not a release. It contains k6 documentation bundles."
