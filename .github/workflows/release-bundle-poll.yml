name: Release Doc Bundle (Poll Fallback)

# Disabled by default. Enable by uncommenting the schedule trigger if
# repository_dispatch from k6's release workflow doesn't work due to
# cross-repo auth issues.
on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Check for new k6 releases
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest k6 release version
          LATEST=$(gh release list -R grafana/k6 --limit 1 --json tagName -q '.[0].tagName')
          echo "Latest k6 release: $LATEST"

          # Map to wildcard version (e.g., v1.5.0 -> v1.5.x)
          WILDCARD=$(echo "$LATEST" | sed 's/\.[0-9]*$/.x/')
          echo "Wildcard version: $WILDCARD"

          # Check if we already have a bundle for this version
          EXISTING=$(gh release list --limit 100 --json tagName -q ".[].tagName" | grep "docs-${WILDCARD}" || true)
          if [ -n "$EXISTING" ]; then
            echo "Bundle already exists for $WILDCARD"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "No bundle for $WILDCARD â€” building"
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "version=$WILDCARD" >> "$GITHUB_OUTPUT"
          fi
      - name: Clone k6-docs
        if: steps.check.outputs.skip != 'true'
        run: git clone --depth 1 https://github.com/grafana/k6-docs.git /tmp/k6-docs
      - name: Prepare docs
        if: steps.check.outputs.skip != 'true'
        run: go run ./cmd/prepare --k6-version=${{ steps.check.outputs.version }} --k6-docs-path=/tmp/k6-docs --output-dir=dist
      - name: Compress bundle
        if: steps.check.outputs.skip != 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y zstd
          tar -cf - -C dist . | zstd --ultra -22 -o docs-${{ steps.check.outputs.version }}.tar.zst
      - name: Publish release
        if: steps.check.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: docs-${{ steps.check.outputs.version }}
          name: "Docs bundle for k6 ${{ steps.check.outputs.version }}"
          files: docs-${{ steps.check.outputs.version }}.tar.zst
          body: "Auto-generated documentation bundle for k6 ${{ steps.check.outputs.version }}"
